<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Real Car - Sistema de Caixa</title>

<style>
  :root{
    --fundo:#111; --painel:#1d1d1d; --borda:#363636; --campo:#262626;
    --vermelho:#d62828; --texto:#f8f9fa; --ok:#6ee7a8; --bad:#fca5a5; --warn:#facc15;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--fundo);color:var(--texto);font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}

  /* Loading */
  .loading-screen{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(0,0,0,.72); z-index:99999; backdrop-filter: blur(3px);
  }
  .loading-card{
    background:var(--painel); border:1px solid var(--borda); border-radius:14px;
    padding:18px 16px; width:320px; max-width:92vw; text-align:center; box-shadow:0 0 18px #000;
  }
  .spinner{
    width:44px; height:44px; border-radius:50%;
    border:4px solid #333; border-top-color: var(--vermelho);
    margin:0 auto 10px; animation: spin 1s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg)}}
  .loading-card b{color:#fff}
  .loading-card p{margin:6px 0 0;color:#cfcfcf;font-size:13px;line-height:1.35}

/* ================= LOGIN ================= */

.login-container{
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  padding:16px;
}

.login-box{
  background:var(--painel);
  padding:28px;
  border-radius:14px;
  box-shadow:0 0 20px #000;
  width:360px;
  max-width:100%;
  text-align:center;
  border:1px solid var(--borda);
}

.login-box h1{margin:0 0 6px;color:var(--vermelho)}
.login-box p{margin:0 0 18px;color:#bbb}

/* Inputs */
.login-box input{
  width:100%;
  height:44px;
  padding:10px 12px;
  margin-bottom:12px;
  border:1px solid #4a4a4a;
  border-radius:8px;
  background:#222;
  color:#fff;
}

.login-box input:focus{
  outline:none;
  border-color:var(--vermelho);
  box-shadow:0 0 0 2px rgba(214,40,40,.45);
}

/* Senha + olho */
.password-row{
  display:flex;
  gap:12px;
  align-items:center;
  margin:10px 0 18px;
}

.password-row input{margin-bottom:0}

/* BOTAO OLHO NEUTRO ‚Äî SOBRESCREVE button{} GLOBAL */
.password-row .toggle-btn{
  background:#1f1f1f !important;
  border:1px solid #3a3a3a !important;
  color:#ccc !important;
  padding:0 !important;
  width:44px;
  height:44px;
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}

.password-row .toggle-btn:hover{
  background:#2a2a2a !important;
}

.password-row .toggle-btn:focus{
  outline:none;
  box-shadow:none !important;
}

/* Bot√£o Entrar (continua vermelho) */
.login-box button{
  width:100%;
  height:46px;
  background:var(--vermelho);
  color:#fff;
  border:none;
  border-radius:8px;
  font-weight:700;
  font-size:15px;
  cursor:pointer;
}

/* Mensagens */
.erro{color:#f87171;margin-top:8px;min-height:20px}
.muted{color:#aaa;font-size:12px;margin-top:6px;line-height:1.35}

  /* Layout App */
  .app-shell{display:none; min-height:100vh}
  .sidebar{
    width:260px; background:#141414; border-right:1px solid var(--borda);
    position:sticky; top:0; height:100vh; padding:16px;
  }
  .brand{display:flex;gap:10px;align-items:center;margin-bottom:14px}
  .brand .dot{width:12px;height:12px;border-radius:50%;background:var(--vermelho)}
  .brand h2{margin:0;font-size:18px}
  .nav{display:flex;flex-direction:column;gap:8px;margin-top:12px}
  .nav button{
    width:100%; text-align:left; padding:10px 12px; border-radius:10px;
    background:#1a1a1a; border:1px solid #2a2a2a; color:#eee; cursor:pointer;
    font-weight:700;
  }
  .nav button.active{border-color:var(--vermelho); background:#231111}
  .side-meta{margin-top:12px; border-top:1px solid #2a2a2a; padding-top:12px; color:#cfcfcf; font-size:12px; line-height:1.4}
  .role-badge{display:inline-block;font-size:12px;padding:6px 10px;border:1px solid var(--borda);border-radius:999px;background:#141414;color:#ccc}
  .side-actions{display:flex; gap:10px; margin-top:12px}
  .side-actions button{flex:1}

  .main{
    flex:1; padding:20px 18px; max-width:1400px; margin:0 auto; width:100%;
  }
  .topbar{
    display:flex; justify-content:space-between; align-items:center;
    gap:12px; margin-bottom:14px;
  }
  .topbar .left{display:flex; align-items:center; gap:10px}
  .hamburger{
    display:none;
    background:#1a1a1a; border:1px solid var(--borda); color:#fff;
    border-radius:10px; padding:10px 12px; cursor:pointer; font-weight:900;
  }
  .topbar h1{margin:0;font-size:20px}
  .topbar .actions{display:flex;gap:10px;align-items:center}
  .secondary{background:#3c3c3c}
  .danger{background:#7a0b0b}

  .container{max-width:1200px;margin:auto}
  .bloco{background:var(--painel);border-radius:12px;padding:22px;margin-bottom:18px;box-shadow:0 0 10px #00000066;border:1px solid var(--borda)}
  .bloco h2{margin:0 0 12px;color:var(--vermelho);border-bottom:1px solid var(--borda);padding-bottom:8px}
  label{display:block;margin-top:10px;font-weight:600}
  input,select{width:100%;padding:10px;border-radius:6px;border:1px solid #444;background:var(--campo);color:#fff;font-size:15px}
  input[disabled], select[disabled]{opacity:.65; cursor:not-allowed;}
  .form-grid{display:flex;gap:14px;flex-wrap:wrap}
  .form-grid>div{flex:1;min-width:220px}
  button{padding:10px 14px;border:none;border-radius:6px;background:var(--vermelho);color:#fff;font-weight:700;cursor:pointer}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center}

  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:9px;border-bottom:1px solid #2f2f2f;font-size:14px;text-align:left;vertical-align:top}
  th{color:#d0d0d0}
  .nowrap{white-space:nowrap}

  .summary{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  .pill{flex:1;min-width:160px;background:#0f0f0f;border-radius:10px;padding:10px 12px;text-align:center;border:1px solid var(--borda)}
  .pill b{display:block;color:#bbb;margin-bottom:4px}
  .ok{color:var(--ok)} .bad{color:var(--bad)} .neutral{color:var(--warn)}
  .hint{color:#bdbdbd;font-size:12px;margin-top:6px;line-height:1.35}
  .tag{display:inline-block;padding:3px 8px;border-radius:999px;background:#333;font-size:12px;margin-left:6px}

  /* Extras (toggle) */
  .extras-head{display:flex;gap:10px;align-items:center;margin-top:8px}
  .extras-head .note{font-size:12px;color:#c6c6c6}
  .extras-box{display:none;margin-top:12px;padding:12px;border-radius:10px;background:#151515;border:1px solid var(--borda)}
  .extras-row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
  #tabelaExtras td{vertical-align:middle}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:#000a;display:none;align-items:center;justify-content:center;z-index:9999}
  .modal{background:var(--painel);border:1px solid var(--borda);border-radius:12px;max-width:820px;width:95%;padding:16px}
  .modal h3{margin:0 0 12px;color:var(--vermelho)}
  .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}

  /* M√≥dulos */
  .module{display:none}
  .module.active{display:block}

  /* Mobile sidebar */
  .sidebar-overlay{display:none; position:fixed; inset:0; background:#0009; z-index:9998}
  .sidebar.mobile{
    position:fixed; left:-280px; top:0; height:100vh; z-index:9999;
    transition:left .18s ease;
  }
  .sidebar.mobile.open{left:0}
  .sidebar-overlay.show{display:block}

  /* mobile: tabela em cards */
  @media (max-width: 900px) {
    .hamburger{display:inline-block}
    .sidebar{display:none}
    .sidebar.mobile{display:block}
    .main{padding:18px 12px}
  }
  @media (max-width: 768px) {
    .form-grid { flex-direction: column; }
    table, thead, tbody, th, td, tr { display: block; width: 100%; }
    thead tr { display: none; }
    tr { margin-bottom: 15px; border:1px solid var(--borda); border-radius:10px; overflow:hidden; }
    td { text-align: right; padding-left: 50%; position: relative; }
    td::before { position: absolute; left: 10px; top: 10px; white-space: nowrap; color: #ccc; font-weight: bold; }

.section-title{
  display:flex;
  align-items:center;
  gap:12px;
}

.badge-count{
  background:#231111;
  border:1px solid var(--vermelho);
  color:var(--vermelho);
  font-size:12px;
  font-weight:700;
  padding:4px 10px;
  border-radius:999px;
}

    /* Entradas */
    #tabelaEntradas td:nth-child(1)::before { content: "Data"; }
    #tabelaEntradas td:nth-child(2)::before { content: "Cliente"; }
    #tabelaEntradas td:nth-child(3)::before { content: "Itens"; }
    #tabelaEntradas td:nth-child(4)::before { content: "Instala√ß√£o"; }
    #tabelaEntradas td:nth-child(5)::before { content: "Pagamento"; }
    #tabelaEntradas td:nth-child(6)::before { content: "Valor"; }
    #tabelaEntradas td:nth-child(7)::before { content: "A√ß√µes"; }

    /* Sa√≠das */
    #tabelaSaidas td:nth-child(1)::before { content: "Data"; }
    #tabelaSaidas td:nth-child(2)::before { content: "Descri√ß√£o"; }
    #tabelaSaidas td:nth-child(3)::before { content: "Categoria"; }
    #tabelaSaidas td:nth-child(4)::before { content: "Valor"; }
    #tabelaSaidas td:nth-child(5)::before { content: "A√ß√µes"; }

    /* Funcion√°rios */
    #tabelaFuncionarios td:nth-child(1)::before { content: "Nome"; }
    #tabelaFuncionarios td:nth-child(2)::before { content: "Sal√°rio"; }
    #tabelaFuncionarios td:nth-child(3)::before { content: "Status"; }
    #tabelaFuncionarios td:nth-child(4)::before { content: "A√ß√µes"; }

    /* Estoque */
    #tabelaEstoque td:nth-child(1)::before { content: "Produto"; }
    #tabelaEstoque td:nth-child(2)::before { content: "Qtd"; }
    #tabelaEstoque td:nth-child(3)::before { content: "M√≠nimo"; }
    #tabelaEstoque td:nth-child(4)::before { content: "A√ß√µes"; }
  }
</style>
</head>
<body>
<!-- LOADING -->
<div id="loadingScreen" class="loading-screen" aria-hidden="true">
  <div class="loading-card">
    <div class="spinner"></div>
    <b>Carregando‚Ä¶</b>
    <p>Validando acesso e sincronizando dados do Firestore.</p>
  </div>
</div>

<!-- LOGIN -->
<div id="loginTela" class="login-container">
  <form id="loginForm" class="login-box">
    <h1>Real Car</h1>
    <p>Sistema de Caixa</p>

    <input id="email" type="email" placeholder="E-mail" autocomplete="username" required>

    <div class="password-row">
      <input id="senha" type="password" placeholder="Senha" autocomplete="current-password" required>
      <button id="toggleSenha" type="button" class="toggle-btn" title="Mostrar/ocultar senha">üëÅ</button>
    </div>

    <button id="btnEntrar" type="submit">Entrar</button>
    <div id="erroLogin" class="erro"></div>
    <div class="muted">Pressione <b>Enter</b> para entrar</div>
  </form>
</div>
<!-- APP SHELL -->
<div id="appShell" class="app-shell">
  <!-- Sidebar Desktop (somente admin) -->
  <aside id="sidebarDesktop" class="sidebar">
    <div class="brand">
      <span class="dot"></span>
      <h2>Real Car</h2>
    </div>

    <div class="nav">
      <button data-mod="modCaixa" class="navbtn active">üìä Caixa</button>
      <button data-mod="modRelatorios" class="navbtn">üßæ Relat√≥rios</button>

      <!-- ADMIN ONLY -->
      <button data-mod="modFuncionarios" class="navbtn admin-only">üßç‚Äç‚ôÇÔ∏è Funcion√°rios</button>
      <button data-mod="modEstoque" class="navbtn admin-only">üì¶ Estoque</button>
    </div>

    <div class="side-meta">
      <div>Perfil: <span id="whoami" class="role-badge">‚Äì</span></div>
      <div style="margin-top:6px">Acesso restrito via Firebase Auth</div>
      <div class="side-actions">
        <button id="btnSairSide" class="secondary" type="button">Sair</button>
      </div>
    </div>
  </aside>

  <!-- Sidebar Mobile -->
  <div id="sidebarOverlay" class="sidebar-overlay"></div>
  <aside id="sidebarMobile" class="sidebar mobile">
    <div class="brand">
      <span class="dot"></span>
      <h2>Real Car</h2>
    </div>

    <div class="nav">
      <button data-mod="modCaixa" class="navbtn active">üìä Caixa</button>
      <button data-mod="modRelatorios" class="navbtn">üßæ Relat√≥rios</button>
      <button data-mod="modFuncionarios" class="navbtn admin-only">üßç‚Äç‚ôÇÔ∏è Funcion√°rios</button>
      <button data-mod="modEstoque" class="navbtn admin-only">üì¶ Estoque</button>
    </div>

    <div class="side-meta">
      <div>Perfil: <span id="whoami2" class="role-badge">‚Äì</span></div>
      <div class="side-actions">
        <button id="btnSairSide2" class="secondary" type="button">Sair</button>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="left">
        <button id="btnHamburger" class="hamburger" type="button">‚ò∞</button>
        <h1 id="pageTitle">üìä Caixa</h1>
      </div>
      <div class="actions">
        <span id="whoamiTop" class="role-badge">‚Äì</span>
        <button id="btnSairTop" class="secondary" type="button">Sair</button>
      </div>
    </div>

    <div class="container">
<!-- ===================== M√ìDULO: CAIXA ===================== -->
<section id="modCaixa" class="module active">
  <!-- Entradas -->
  <div class="bloco" id="blocoEntradas">
    <h2 class="section-title">
  Entradas
  <span class="badge-count" id="countEntradas">0 lan√ß.</span>
</h2>

    <div class="form-grid">
      <div>
        <label>Data</label>
        <input id="dataEntrada" type="date"/>
      </div>

      <div>
        <label>Descri√ß√£o</label>
        <input id="clienteEntrada" type="text" placeholder="Ex.: HB20">
        <div class="hint">Use <b>EX: NOME DA ENTRADA</b>.</div>
      </div>

      <div>
        <label>Tipo</label>
        <select id="tipoEntrada">
          <option>Dianteiro</option>
          <option>Traseiro</option>
          <option>Dianteiro + Traseiro</option>
          <option>Dianteiro + Servi√ßo</option>
          <option>Traseiro + Servi√ßo</option>
          <option>Dianteiro + Traseiro + Servi√ßo</option>
          <option>Amortecedor Central</option>
          <option>Servi√ßo</option>
          <option>Ferro Velho</option>
          <option>Hastes</option>
          <option>Oficina</option>
        </select>
      </div>

      <div id="divServico" style="display:none">
        <label>Descri√ß√£o do Servi√ßo</label>
        <input id="descricaoServico" type="text" placeholder="Ex.: TROCA DE COXIM, BATEDOR..."/>
      </div>

      <div id="instalacaoBox">
        <label>Instala√ß√£o</label>
        <select id="instalacaoEntrada">
          <option>Instalado na Oficina</option>
          <option>Amortecedor Fora</option>
        </select>
      </div>

      <div>
        <label>Qtd</label>
        <input id="qtdEntrada" type="number" value="1" min="1">
      </div>
    </div>

    <!-- Extras (toggle) -->
    <div class="extras-head">
      <button class="secondary" id="toggleExtras" type="button">+ Itens Extras (opcional)</button>
      <span class="note">Use apenas quando o cliente levar mais de um item.</span>
    </div>
    <div class="extras-box" id="extrasBox">
      <div class="extras-row">
        <div style="flex:2;min-width:200px">
          <label>Tipo</label>
          <select id="exTipo">
            <option>Dianteiro</option>
            <option>Traseiro</option>
            <option>Dianteiro + Traseiro</option>
            <option>Dianteiro + Servi√ßo</option>
            <option>Traseiro + Servi√ßo</option>
            <option>Amortecedor Central</option>
            <option>Servi√ßo</option>
            <option>Ferro Velho</option>
            <option>Hastes</option>
            <option>Oficina</option>
          </select>
        </div>
        <div style="flex:1;min-width:120px">
          <label>Qtd</label>
          <input id="exQtd" type="number" min="1" value="1">
        </div>
        <div style="flex:2;min-width:180px">
          <label>Descri√ß√£o</label>
          <input id="exObs" type="text" placeholder="Ex.: HB20">
        </div>
        <div style="flex:3;min-width:240px" id="exDescBox" hidden>
          <label>Descri√ß√£o do Servi√ßo</label>
          <input id="exDesc" type="text" placeholder="Ex.: TROCA DE COXIM, BATEDOR...">
        </div>
        <div>
          <button id="btnAddExtra" type="button">+ Adicionar</button>
        </div>
      </div>
      <table id="tabelaExtras">
        <thead><tr><th>Tipo</th><th>Qtd</th><th>Descri√ß√£o</th><th>A√ß√µes</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <!-- Pagamento -->
    <div class="form-grid" style="margin-top:6px">
      <div>
        <label>Forma de Pagamento</label>
        <select id="formaPagamento">
          <option>Pix</option>
          <option>Dinheiro</option>
          <option>Cart√£o</option>
          <option>Combinado</option>
        </select>
      </div>

      <!-- Valor √∫nico (quando N√ÉO √© Combinado) -->
      <div id="boxValorUnico">
        <label>Valor Total (R$)</label>
        <input id="valorEntrada" type="number" step="0.01" placeholder="0,00">
      </div>

      <!-- Pagamento Combinado -->
      <div id="boxCombinado" style="display:none;flex-basis:100%">
        <label>Pagamentos (somar at√© o total desejado)</label>
        <div class="pay-row" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <div class="pay-item" style="display:flex;gap:6px;align-items:center;border:1px solid var(--borda);border-radius:8px;padding:6px 8px;background:#141414">
            <span>Pix</span>
            <input id="payPixVal" type="number" step="0.01" placeholder="0,00" style="width:120px">
          </div>
          <div class="pay-item" style="display:flex;gap:6px;align-items:center;border:1px solid var(--borda);border-radius:8px;padding:6px 8px;background:#141414">
            <span>Dinheiro</span>
            <input id="payDinVal" type="number" step="0.01" placeholder="0,00" style="width:120px">
          </div>
          <div class="pay-item" style="display:flex;gap:6px;align-items:center;border:1px solid var(--borda);border-radius:8px;padding:6px 8px;background:#141414">
            <span>Cart√£o</span>
            <input id="payCartaoVal" type="number" step="0.01" placeholder="0,00" style="width:120px">
          </div>
        </div>
      </div>
    </div>

    <div class="toolbar">
      <button id="btnAddEntrada" type="button">+ Adicionar Entrada</button>
    </div>

    <table id="tabelaEntradas">
      <thead>
        <tr>
          <th>Data</th><th>Cliente</th><th>Itens</th><th>Instala√ß√£o</th><th>Pagamento</th><th>Valor</th><th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Sa√≠das -->
  <div class="bloco" id="blocoSaidas">
    <h2>Sa√≠das</h2>
    <div class="form-grid">
      <div><label>Data</label><input id="dataSaida" type="date"></div>
      <div><label>Descri√ß√£o</label><input id="descricaoSaida" type="text"></div>
      <div>
        <label>Categoria</label>
        <select id="categoriaSaida">
          <option>Alimenta√ß√£o</option>
          <option>Supermercado</option>
          <option>Transporte</option>
          <option>Compra de Carca√ßa</option>
          <option>Ferramentas</option>
          <option>√ìrg√¥nio/Nitrog√™nio</option>
          <option>Tinta e Tinner</option>
          <option>Disco do Esmeril</option>
          <option>Vareta de Solda</option>
          <option>Pe√ßas</option>
          <option>Outros</option>
        </select>
      </div>
      <div><label>Valor (R$)</label><input id="valorSaida" type="number" step="0.01"></div>
    </div>
    <div class="toolbar">
      <button id="btnAddSaida" type="button">+ Adicionar Sa√≠da</button>
    </div>
    <table id="tabelaSaidas">
      <thead>
        <tr><th>Data</th><th>Descri√ß√£o</th><th>Categoria</th><th>Valor</th><th>A√ß√µes</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>
<!-- ===================== M√ìDULO: RELAT√ìRIOS ===================== -->
<section id="modRelatorios" class="module">
  <div class="bloco" id="blocoResumo">
    <h2>Filtros e Resumo</h2>
    <div class="form-grid">
      <div><label>Buscar</label><input id="campoBusca" type="text" placeholder="üîç nome, tipo, forma..."></div>
      <div><label>Filtro por Dia</label><input id="filtroDia" type="date"></div>
      <div><label>Filtro por M√™s</label><input id="filtroMes" type="month"></div>
    </div>
    <div class="summary">
      <div class="pill"><b>Total Entradas</b><span id="totalEntradas" class="ok">R$ 0,00</span></div>
      <div class="pill"><b>Total Sa√≠das</b><span id="totalSaidas" class="bad">R$ 0,00</span></div>
      <div class="pill"><b>Folha (ativos)</b><span id="totalFolha" class="bad">R$ 0,00</span></div>
      <div class="pill"><b>Saldo</b><span id="saldo" class="neutral">R$ 0,00</span></div>
      <div class="pill"><b>PIX</b><span id="totalPix">R$ 0,00</span></div>
      <div class="pill"><b>Cart√£o</b><span id="totalCartao">R$ 0,00</span></div>
      <div class="pill"><b>Dinheiro</b><span id="totalDinheiro">R$ 0,00</span></div>
    </div>
  </div>

  <div class="bloco" id="blocoRelatorios">
    <h2>Backup e Relat√≥rios</h2>
    <div class="toolbar">
      <button class="secondary" id="btnLimparFiltros" type="button">üßπ Limpar Filtros</button>
      <button class="secondary" id="btnExportCSV" type="button">üìÅ Exportar CSV</button>
      <button class="secondary" id="btnExportJSON" type="button">üíæ Exportar Backup</button>
      <button class="secondary" id="btnImprimir" type="button">üñ®Ô∏è Imprimir Relat√≥rio</button>
      <button class="secondary admin-only" id="btnFecharMes" type="button">üìÖ Fechar M√™s</button>
    </div>
  </div>
</section>
<!-- ===================== M√ìDULO: FUNCION√ÅRIOS (ADMIN) ===================== -->
<section id="modFuncionarios" class="module admin-only">
  <div class="bloco">
    <h2>Funcion√°rios</h2>

    <div class="form-grid">
      <div>
        <label>Nome</label>
        <input id="funcNome" type="text" placeholder="Ex.: JO√ÉO">
      </div>
      <div>
        <label>Sal√°rio (R$)</label>
        <input id="funcSalario" type="number" step="0.01" placeholder="0,00">
      </div>
      <div>
        <label>Status</label>
        <select id="funcAtivo">
          <option value="true">Ativo</option>
          <option value="false">Inativo</option>
        </select>
      </div>
    </div>

    <div class="toolbar">
      <button id="btnAddFunc" type="button">+ Adicionar Funcion√°rio</button>
      <button class="secondary" id="btnRecalcFolha" type="button">üîÑ Recalcular Folha</button>
    </div>

    <table id="tabelaFuncionarios">
      <thead><tr><th>Nome</th><th>Sal√°rio</th><th>Status</th><th>A√ß√µes</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</section>
<!-- ===================== M√ìDULO: ESTOQUE (ADMIN) ===================== -->
<section id="modEstoque" class="module admin-only">
  <div class="bloco">
    <h2>Estoque</h2>

    <div class="form-grid">
      <div>
        <label>Produto</label>
        <input id="estNome" type="text" placeholder="Ex.: √ìLEO">
      </div>
      <div>
        <label>Quantidade</label>
        <input id="estQtd" type="number" step="1" placeholder="0">
      </div>
      <div>
        <label>M√≠nimo</label>
        <input id="estMin" type="number" step="1" placeholder="0">
      </div>
    </div>

    <div class="toolbar">
      <button id="btnAddEst" type="button">+ Adicionar Produto</button>
    </div>

    <table id="tabelaEstoque">
      <thead><tr><th>Produto</th><th>Qtd</th><th>M√≠nimo</th><th>A√ß√µes</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="bloco">
    <h2>Hist√≥rico de Movimenta√ß√£o</h2>
    <div class="hint">Aparece quando voc√™ altera a quantidade em editar.</div>
    <table id="tabelaEstoqueHist">
      <thead><tr><th>Data/Hora</th><th>Produto</th><th>Antes</th><th>Depois</th><th>Diferen√ßa</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</section>

</div><!-- /container -->
</main>
</div><!-- /appShell -->

<div id="printArea" style="display:none"></div>
<!-- MODAL DE EDI√á√ÉO DE ENTRADA -->
<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Editar Entrada</h3>
    <div class="form-grid">
      <div><label>Data</label><input id="m_data" type="date"></div>
      <div><label>Cliente</label><input id="m_cliente" type="text"></div>

      <div>
        <label>Tipo</label>
        <select id="m_tipo">
          <option>Dianteiro</option>
          <option>Traseiro</option>
          <option>Dianteiro + Traseiro</option>
          <option>Dianteiro + Servi√ßo</option>
          <option>Traseiro + Servi√ßo</option>
          <option>Dianteiro + Traseiro + Servi√ßo</option>
          <option>Amortecedor Central</option>
          <option>Servi√ßo</option>
          <option>Ferro Velho</option>
          <option>Hastes</option>
          <option>Oficina</option>
        </select>
      </div>

      <div id="m_divServico" style="display:none">
        <label>Descri√ß√£o do Servi√ßo</label>
        <input id="m_descServico" type="text"/>
      </div>

      <div>
        <label>Instala√ß√£o</label>
        <select id="m_instalacao">
          <option>Instalado na Oficina</option>
          <option>Amortecedor Fora</option>
        </select>
      </div>

      <div><label>Qtd</label><input id="m_qtd" type="number" min="1"></div>

      <div>
        <label>Forma de Pagamento</label>
        <select id="m_formaPagamento">
          <option>Pix</option>
          <option>Dinheiro</option>
          <option>Cart√£o</option>
          <option>Combinado</option>
        </select>
      </div>

      <div id="m_boxValorUnico">
        <label>Valor (R$)</label>
        <input id="m_valor" type="number" step="0.01">
      </div>

      <div id="m_boxCombinado" style="display:none;flex-basis:100%">
        <label>Pagamentos</label>
        <div class="pay-row" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <div class="pay-item"><span>Pix</span><input id="m_payPixVal" type="number" step="0.01" placeholder="0,00" style="width:120px"></div>
          <div class="pay-item"><span>Dinheiro</span><input id="m_payDinVal" type="number" step="0.01" placeholder="0,00" style="width:120px"></div>
          <div class="pay-item"><span>Cart√£o</span><input id="m_payCartaoVal" type="number" step="0.01" placeholder="0,00" style="width:120px"></div>
        </div>
      </div>
    </div>
    <div class="actions">
      <button class="secondary" onclick="fecharModal()">Cancelar</button>
      <button onclick="salvarEdicaoEntrada()">Salvar</button>
    </div>
  </div>
</div>

<!-- MODAL DE EDI√á√ÉO DE SA√çDA -->
<div id="modalSaidaBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Editar Sa√≠da</h3>
    <div class="form-grid">
      <div><label>Data</label><input id="m_dataSaida" type="date"></div>
      <div><label>Descri√ß√£o</label><input id="m_descSaida" type="text"></div>
      <div>
        <label>Categoria</label>
        <select id="m_categoriaSaida">
          <option>Alimenta√ß√£o</option>
          <option>Supermercado</option>
          <option>Transporte</option>
          <option>Compra de Carca√ßa</option>
          <option>Ferramentas</option>
          <option>√ìrg√¥nio/Nitrog√™nio</option>
          <option>Tinta e Tinner</option>
          <option>Disco do Esmeril</option>
          <option>Vareta de Solda</option>
          <option>Pe√ßas</option>
          <option>Outros</option>
        </select>
      </div>
      <div><label>Valor (R$)</label><input id="m_valorSaida" type="number" step="0.01"></div>
    </div>
    <div class="actions">
      <button class="secondary" onclick="fecharModalSaida()">Cancelar</button>
      <button onclick="salvarEdicaoSaida()">Salvar</button>
    </div>
  </div>
</div>
<!-- MODAL FUNCION√ÅRIO -->
<div id="modalFuncBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Editar Funcion√°rio</h3>
    <div class="form-grid">
      <div>
        <label>Nome</label>
        <input id="mFuncNome" type="text">
      </div>
      <div>
        <label>Sal√°rio (R$)</label>
        <input id="mFuncSalario" type="number" step="0.01">
      </div>
      <div>
        <label>Status</label>
        <select id="mFuncAtivo">
          <option value="true">Ativo</option>
          <option value="false">Inativo</option>
        </select>
      </div>
    </div>
    <div class="actions">
      <button class="secondary" onclick="fecharModalFunc()">Cancelar</button>
      <button onclick="salvarFunc()">Salvar</button>
    </div>
  </div>
</div>

<!-- MODAL ESTOQUE -->
<div id="modalEstBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Editar Produto</h3>
    <div class="form-grid">
      <div>
        <label>Produto</label>
        <input id="mEstNome" type="text">
      </div>
      <div>
        <label>Quantidade</label>
        <input id="mEstQtd" type="number" step="1">
      </div>
      <div>
        <label>M√≠nimo</label>
        <input id="mEstMin" type="number" step="1">
      </div>
    </div>
    <div class="actions">
      <button class="secondary" onclick="fecharModalEst()">Cancelar</button>
      <button onclick="salvarEst()">Salvar</button>
    </div>
  </div>
</div>
<script type="module">
// ========================= PARTE 01/18 =========================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, addDoc, doc, updateDoc, deleteDoc,
  onSnapshot, getDocs, query, orderBy, serverTimestamp, getDoc, limit
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {
  getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCaaZf78WgruFolJ0FfLKrn7cKjsS00dc0",
  authDomain: "realcar-caixa.firebaseapp.com",
  projectId: "realcar-caixa",
  storageBucket: "realcar-caixa.appspot.com",
  messagingSenderId: "853035037951",
  appId: "1:853035037951:web:5ae763aa016d204acfc8ca"
};

const appFB = initializeApp(firebaseConfig);
const db = getFirestore(appFB);
const auth = getAuth(appFB);

// ====== Estado ======
let entradas = [], saidas = [];
let editIndex = -1;
let saidaEditIndex = -1;

let extras = []; // [{tipo,qtd,obs,serv}]
let role = 'func';
let today = new Date().toLocaleDateString('fr-CA');

let funcionarios = []; // admin
let estoque = [];      // admin
let estoqueHist = [];  // admin

let funcEditIndex = -1;
let estEditIndex = -1;

let unsubEntradas = null;
let unsubSaidas   = null;
let unsubFuncs    = null;
let unsubEstoque  = null;
let unsubHist     = null;

// ‚úÖ FIX LOOPING: flags para n√£o reinicializar UI/Realtime infinitamente
let uiStarted = false;
let realtimeStarted = false;
let authHandledOnce = false; // evita posLogin duplicado em alguns cen√°rios

// ====== Utils ======
const BRL = v => (parseFloat(v||0)).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const esc = s => String(s??"").replace(/[&<>\"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
const parseNum = v => parseFloat(String(v??0).replace(',','.'))||0;

function somaPag(p){ return (parseNum(p?.pix)+parseNum(p?.cartao)+parseNum(p?.dinheiro)); }
function fmtPag(p){
  const parts=[];
  if(parseNum(p?.pix)>0) parts.push(`Pix ${BRL(p.pix)}`);
  if(parseNum(p?.cartao)>0) parts.push(`Cart√£o ${BRL(p.cartao)}`);
  if(parseNum(p?.dinheiro)>0) parts.push(`Dinheiro ${BRL(p.dinheiro)}`);
  return parts.join(" + ") || "-";
}
// ========================= PARTE 02/18 =========================
// Loading UI
const loadingScreen = document.getElementById('loadingScreen');

function showLoading(txt){
  loadingScreen.style.display='flex';
  loadingScreen.setAttribute('aria-hidden','false');
  if(txt){
    const p = loadingScreen.querySelector('p');
    if(p) p.textContent = txt;
  }
}
function hideLoading(){
  loadingScreen.style.display='none';
  loadingScreen.setAttribute('aria-hidden','true');
}

// Modules / Sidebar
function setTitle(t){ document.getElementById('pageTitle').textContent = t; }

function closeMobileSidebar(){
  document.getElementById('sidebarMobile').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('show');
}
function openMobileSidebar(){
  document.getElementById('sidebarMobile').classList.add('open');
  document.getElementById('sidebarOverlay').classList.add('show');
}

function gotoModule(id){
  document.querySelectorAll('.module').forEach(m=>m.classList.remove('active'));
  document.getElementById(id).classList.add('active');

  document.querySelectorAll('.navbtn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll(`.navbtn[data-mod="${id}"]`).forEach(b=>b.classList.add('active'));

  if(id==='modCaixa') setTitle('üìä Caixa');
  if(id==='modRelatorios') setTitle('üßæ Relat√≥rios');
  if(id==='modFuncionarios') setTitle('üßç‚Äç‚ôÇÔ∏è Funcion√°rios');
  if(id==='modEstoque') setTitle('üì¶ Estoque');

  closeMobileSidebar();
}

// Admin-only visibility
function applyAdminOnlyUI(){
  const isA = (role==='admin');
  document.querySelectorAll('.admin-only').forEach(el=>{
    el.style.display = isA ? '' : 'none';
  });
}

// ====== Login UI ======
const toggleSenha = document.getElementById('toggleSenha');
toggleSenha.addEventListener('click', ()=>{
  const inp = document.getElementById('senha');
  inp.type = (inp.type==='password') ? 'text' : 'password';
});
// ========================= PARTE 03/18 =========================
async function entrar(){
  const email = document.getElementById('email').value.trim();
  const senha = document.getElementById('senha').value.trim();
  const msg = document.getElementById('erroLogin');
  msg.textContent = '';

  showLoading('Validando acesso‚Ä¶');
  try{
    await signInWithEmailAndPassword(auth, email, senha);
    // posLogin √© chamado pelo onAuthStateChanged
  }catch(err){
    msg.textContent = 'Falha no login. Verifique e-mail/senha.';
    console.error(err);
    hideLoading(); // ‚úÖ importante: n√£o deixar loading preso no erro
  }
}

function safeUnsubAll(){
  if (unsubEntradas) { unsubEntradas(); unsubEntradas = null; }
  if (unsubSaidas)   { unsubSaidas();   unsubSaidas = null; }
  if (unsubFuncs)    { unsubFuncs();    unsubFuncs = null; }
  if (unsubEstoque)  { unsubEstoque();  unsubEstoque = null; }
  if (unsubHist)     { unsubHist();     unsubHist = null; }
}

function resetSessionState(){
  entradas=[]; saidas=[]; funcionarios=[]; estoque=[]; estoqueHist=[];
  extras=[]; editIndex=-1; saidaEditIndex=-1; funcEditIndex=-1; estEditIndex=-1;
}

function sair(){
  showLoading('Saindo‚Ä¶');
  safeUnsubAll();

  // ‚úÖ FIX LOOPING: reset flags para permitir iniciar de novo na pr√≥xima sess√£o
  uiStarted = false;
  realtimeStarted = false;
  authHandledOnce = false;

  signOut(auth)
    .catch(console.error)
    .finally(()=> hideLoading());
}

document.getElementById('loginForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  entrar();
});

// binds logout buttons
document.getElementById('btnSairTop').addEventListener('click', sair);
document.getElementById('btnSairSide').addEventListener('click', sair);
document.getElementById('btnSairSide2').addEventListener('click', sair);

// Mobile sidebar handlers
document.getElementById('btnHamburger').addEventListener('click', openMobileSidebar);
document.getElementById('sidebarOverlay').addEventListener('click', closeMobileSidebar);

document.querySelectorAll('.navbtn').forEach(btn=>{
  btn.addEventListener('click', ()=> gotoModule(btn.dataset.mod));
});
// ========================= PARTE 04/18 =========================
// ====== Auth state ======
onAuthStateChanged(auth, async (user)=>{
  if(user){
    // ‚úÖ FIX LOOPING: evita rodar posLogin mais de uma vez por sess√£o
    if(authHandledOnce) return;
    authHandledOnce = true;

    showLoading('Carregando perfil e dados‚Ä¶');

    try{
      const rdoc = await getDoc(doc(db,'users',user.uid));
      role = (rdoc.exists() && rdoc.data().role) ? rdoc.data().role : 'func';
    }catch(e){
      role = 'func';
    }

    posLogin();
  } else {
    // Logout visual
    safeUnsubAll();
    resetSessionState();

    // ‚úÖ FIX LOOPING: reset flags ao sair
    uiStarted = false;
    realtimeStarted = false;
    authHandledOnce = false;

    document.getElementById('appShell').style.display='none';
    document.getElementById('loginTela').style.display='flex';
    document.getElementById('erroLogin').textContent='';
    hideLoading();

    try{ document.getElementById('email').focus(); }catch(_){}
  }
});

function posLogin(){
  document.getElementById('loginTela').style.display='none';
  document.getElementById('appShell').style.display='flex';

  const label = (role==='admin') ? 'Administrador' : 'Funcion√°rio';
  document.getElementById('whoami').textContent = label;
  document.getElementById('whoami2').textContent = label;
  document.getElementById('whoamiTop').textContent = label;

  applyAdminOnlyUI();

  document.getElementById('dataEntrada').value = today;
  document.getElementById('dataSaida').value   = today;
  document.getElementById('filtroDia').value   = today;

  const campoBusca = document.getElementById('campoBusca');
  const filtroDia  = document.getElementById('filtroDia');
  const filtroMes  = document.getElementById('filtroMes');

  if(role !== 'admin'){
    campoBusca.value = '';
    campoBusca.disabled = true;
    filtroMes.value = '';
    filtroMes.disabled = true;
    filtroDia.disabled = true;
    const bm = document.getElementById('btnFecharMes');
    if(bm) bm.style.display='none';
  }else{
    campoBusca.disabled = false;
    filtroDia.disabled = false;
    filtroMes.disabled = false;
    const bm = document.getElementById('btnFecharMes');
    if(bm) bm.style.display='';
  }

  // ‚úÖ FIX LOOPING: initUI/initRealtime apenas uma vez por sess√£o
  if(!uiStarted){
    initUI();
    uiStarted = true;
  }
  if(!realtimeStarted){
    initRealtime();
    realtimeStarted = true;
  }

  gotoModule('modCaixa');
}
// ========================= PARTE 05/18 =========================
function initUI(){
  // listeners (apenas 1x por sess√£o)
  document.getElementById('btnAddEntrada').addEventListener('click', adicionarEntrada);
  document.getElementById('btnAddSaida').addEventListener('click', adicionarSaida);

  document.getElementById('campoBusca').addEventListener('input', render);
  document.getElementById('filtroDia').addEventListener('change', render);
  document.getElementById('filtroMes').addEventListener('change', render);

  document.getElementById('btnLimparFiltros').addEventListener('click', limparFiltros);
  document.getElementById('btnExportCSV').addEventListener('click', exportarCSV);
  document.getElementById('btnExportJSON').addEventListener('click', exportarJSON);
  document.getElementById('btnImprimir').addEventListener('click', imprimirRelatorio);

  const bm = document.getElementById('btnFecharMes');
  if(bm) bm.addEventListener('click', fecharMes);

  // extras
  const extrasBox = document.getElementById('extrasBox');
  const toggleExtra = document.getElementById('toggleExtras');

  toggleExtra.onclick = ()=>{
    const open = extrasBox.style.display === 'block';
    extrasBox.style.display = open ? 'none' : 'block';
    toggleExtra.textContent = open ? '+ Itens Extras (opcional)' : '‚àí Ocultar Itens Extras';
  };

  const exTipo = document.getElementById('exTipo');
  const exDescBox = document.getElementById('exDescBox');
  exTipo.onchange = ()=>{
    const t = exTipo.value;
    exDescBox.hidden = !(t.includes('Servi√ßo') || t === 'Servi√ßo');
  };
  document.getElementById('btnAddExtra').onclick = addExtra;

  document.getElementById('tipoEntrada').addEventListener('change', ()=>{
    const t = document.getElementById('tipoEntrada').value;
    document.getElementById('divServico').style.display =
      (t.includes('Servi√ßo') || t === 'Servi√ßo' || t === 'Dianteiro + Traseiro + Servi√ßo') ? 'block':'none';
    updateInstalacaoVisibility();
  });

  document.getElementById('formaPagamento').addEventListener('change', ()=>{
    const f = document.getElementById('formaPagamento').value;
    document.getElementById('boxCombinado').style.display = (f==="Combinado") ? "block":"none";
    document.getElementById('boxValorUnico').style.display = (f==="Combinado") ? "none":"block";
  });

  // admin buttons
  if(role==='admin'){
    document.getElementById('btnAddFunc')?.addEventListener('click', adicionarFuncionario);
    document.getElementById('btnRecalcFolha')?.addEventListener('click', recalcularFolha);
    document.getElementById('btnAddEst')?.addEventListener('click', adicionarProduto);
  }
}
// ========================= PARTE 06/18 =========================
function initRealtime(){
  safeUnsubAll();

  let carregados = 0;
  const TOTAL = (role === 'admin') ? 5 : 2;

  // fallback de seguran√ßa
  let timeout = setTimeout(()=>{
    hideLoading();
  }, 5000);

  const done = ()=>{
    carregados++;
    if(carregados >= TOTAL){
      clearTimeout(timeout);
      hideLoading();
    }
  };

  unsubEntradas = onSnapshot(
    query(collection(db,'entradas'), orderBy('data','asc')),
    snap=>{
      entradas = snap.docs.map(d=>({id:d.id,...d.data()}));
      render();
      done();
    },
    err=>{
      console.error("Erro entradas:", err);
      done();
    }
  );

  unsubSaidas = onSnapshot(
    query(collection(db,'saidas'), orderBy('data','asc')),
    snap=>{
      saidas = snap.docs.map(d=>({id:d.id,...d.data()}));
      render();
      done();
    },
    err=>{
      console.error("Erro saidas:", err);
      done();
    }
  );

  if(role==='admin'){
    unsubFuncs = onSnapshot(
      collection(db,'funcionarios'),
      snap=>{
        funcionarios = snap.docs.map(d=>({id:d.id,...d.data()}));
        renderFuncionarios();
        render();
        done();
      },
      err=>{
        console.error("Erro funcs:", err);
        done();
      }
    );

    unsubEstoque = onSnapshot(
      collection(db,'estoque'),
      snap=>{
        estoque = snap.docs.map(d=>({id:d.id,...d.data()}));
        renderEstoque();
        done();
      },
      err=>{
        console.error("Erro estoque:", err);
        done();
      }
    );

    unsubHist = onSnapshot(
      query(collection(db,'estoque_historico'), orderBy('createdAt','desc'), limit(40)),
      snap=>{
        estoqueHist = snap.docs.map(d=>({id:d.id,...d.data()}));
        renderEstoqueHist();
        done();
      },
      err=>{
        console.error("Erro hist:", err);
        done();
      }
    );
  }
}
// ========================= PARTE 07/18 =========================
// ====== Instala√ß√£o hide (Ferro/Hastes) ======
function allItensFerroHastes(){
  const base = document.getElementById('tipoEntrada').value;
  const isFH = t => (t === 'Ferro Velho' || t === 'Hastes');
  if(!isFH(base)) return false;
  return extras.every(it => isFH(it.tipo));
}

function updateInstalacaoVisibility(){
  const box = document.getElementById('instalacaoBox');
  const hide = allItensFerroHastes();
  box.style.display = hide ? 'none' : 'block';
  if(hide) document.getElementById('instalacaoEntrada').value = '';
}

// ====== Extras ======
function renderExtras(){
  const tb = document.querySelector('#tabelaExtras tbody');
  tb.innerHTML = extras.map((it,i)=>{
    const descricao = [
      it.obs  ? `OBS: ${esc(it.obs)}`   : '',
      it.serv ? `SERVI√áO: ${esc(it.serv)}` : ''
    ].filter(Boolean).join(' ‚Äî ');

    return `
      <tr>
        <td>${esc(it.tipo)}</td>
        <td>${it.qtd}</td>
        <td>${descricao || '-'}</td>
        <td class="nowrap">
          ${role==='admin' ? `<button class="danger" type="button" onclick="removerExtra(${i})">üóëÔ∏è</button>` : ''}
        </td>
      </tr>`;
  }).join('');
  updateInstalacaoVisibility();
}

window.removerExtra = (i)=>{ extras.splice(i,1); renderExtras(); };

function addExtra(){
  const exQtd  = parseInt(document.getElementById('exQtd').value || '1', 10);
  const exTipo = document.getElementById('exTipo').value;
  const exObs  = (document.getElementById('exObs').value || '').trim().toUpperCase();
  const exServ = document.getElementById('exDescBox').hidden ? '' : (document.getElementById('exDesc').value || '').trim().toUpperCase();

  if(exQtd<=0){ alert('Informe uma quantidade v√°lida.'); return; }
  if(!document.getElementById('exDescBox').hidden && !exServ){
    alert('Descreva o servi√ßo.'); return;
  }
  extras.push({ tipo: exTipo, qtd: exQtd, obs: exObs, serv: exServ });
  document.getElementById('exQtd').value = 1;
  document.getElementById('exObs').value = '';
  document.getElementById('exDesc').value = '';
  renderExtras();
}
// ========================= PARTE 08/18 =========================
// ====== Permiss√£o ======
const canDeleteEntrada = (e) => {
  const isToday = (e?.data || '') === today;
  return role === 'admin' || (role === 'func' && isToday);
};

// ====== CRUD Entradas ======
async function adicionarEntrada(){
  const cliente = (document.getElementById('clienteEntrada').value||'').trim().toUpperCase();
  const data    = document.getElementById('dataEntrada').value || today;
  let instalacao= document.getElementById('instalacaoEntrada').value;
  const tipoSel = document.getElementById('tipoEntrada').value;
  const qtd     = parseInt(document.getElementById('qtdEntrada').value||'1',10);
  const descSrv = (document.getElementById('divServico').style.display==='none') ? '' :
                  (document.getElementById('descricaoServico').value||'').trim().toUpperCase();

  if(!cliente){ alert('Informe o cliente'); return; }
  if(qtd<=0){ alert('Quantidade inv√°lida'); return; }

  if(allItensFerroHastes()) instalacao = '';

  const formaSel = document.getElementById('formaPagamento').value;
  let pagamento = { pix:0, dinheiro:0, cartao:0 };
  let total = 0;

  if(formaSel==='Combinado'){
    pagamento.pix      = parseNum(document.getElementById('payPixVal').value);
    pagamento.dinheiro = parseNum(document.getElementById('payDinVal').value);
    pagamento.cartao   = parseNum(document.getElementById('payCartaoVal').value);
    total = somaPag(pagamento);
    if(total<=0){ alert('Informe pelo menos um valor no combinado.'); return; }
  }else{
    total = parseNum(document.getElementById('valorEntrada').value);
    if(total<=0){ alert('Informe um valor v√°lido.'); return; }
    if(formaSel==='Pix') pagamento.pix = total;
    if(formaSel==='Dinheiro') pagamento.dinheiro = total;
    if(formaSel==='Cart√£o') pagamento.cartao = total;
  }

  const nova = {
    data, cliente,
    tipo: tipoSel, qtd, descricao: descSrv,
    extras,
    instalacao,
    pagamento, valor: total,
    forma: (formaSel==='Combinado') ? fmtPag(pagamento) : formaSel,
    createdAt: serverTimestamp()
  };

  await addDoc(collection(db,'entradas'), nova);

  document.getElementById('clienteEntrada').value='';
  document.getElementById('qtdEntrada').value='1';
  document.getElementById('valorEntrada').value='';
  document.getElementById('descricaoServico').value='';
  document.getElementById('divServico').style.display='none';
  document.getElementById('payPixVal').value='';
  document.getElementById('payDinVal').value='';
  document.getElementById('payCartaoVal').value='';

  extras = [];
  renderExtras();
}
window.adicionarEntrada = adicionarEntrada;
// ========================= PARTE 09/18 =========================
function abrirModalEntrada(realIndex){
  const e=entradas[realIndex]; if(!e) return;
  editIndex = realIndex;

  document.getElementById('m_data').value = e.data || today;
  document.getElementById('m_cliente').value = e.cliente || '';
  document.getElementById('m_tipo').value = e.tipo || 'Dianteiro';
  document.getElementById('m_instalacao').value = e.instalacao || '';
  document.getElementById('m_qtd').value = e.qtd || 1;

  const precisaSrv = (e.tipo?.includes('Servi√ßo') || e.tipo==='Servi√ßo' || e.tipo==='Dianteiro + Traseiro + Servi√ßo');
  document.getElementById('m_divServico').style.display = precisaSrv ? 'block':'none';
  document.getElementById('m_descServico').value = e.descricao || '';

  const p = e.pagamento || {pix:0, cartao:0, dinheiro:0};
  const temCombo = [p.pix, p.cartao, p.dinheiro].filter(v=>parseNum(v)>0).length > 1;
  document.getElementById('m_formaPagamento').value = temCombo
    ? 'Combinado'
    : (parseNum(p.pix)>0 ? 'Pix' : parseNum(p.cartao)>0 ? 'Cart√£o' : 'Dinheiro');

  alternarModalPagamentoUI();

  if (document.getElementById('m_formaPagamento').value==='Combinado'){
    document.getElementById('m_payPixVal').value = parseNum(p.pix)||'';
    document.getElementById('m_payDinVal').value = parseNum(p.dinheiro)||'';
    document.getElementById('m_payCartaoVal').value = parseNum(p.cartao)||'';
    document.getElementById('m_valor').value = '';
  } else {
    document.getElementById('m_valor').value = parseNum(e.valor)||0;
    document.getElementById('m_payPixVal').value = '';
    document.getElementById('m_payDinVal').value = '';
    document.getElementById('m_payCartaoVal').value = '';
  }

  document.getElementById('modalBackdrop').style.display='flex';

  document.getElementById('m_tipo').onchange = () => {
    const t = document.getElementById('m_tipo').value;
    document.getElementById('m_divServico').style.display =
      (t.includes('Servi√ßo') || t==='Servi√ßo' || t==='Dianteiro + Traseiro + Servi√ßo') ? 'block':'none';
  };
  document.getElementById('m_formaPagamento').onchange = alternarModalPagamentoUI;
}
window.abrirModalEntrada = abrirModalEntrada;

function alternarModalPagamentoUI(){
  const f = document.getElementById('m_formaPagamento').value;
  document.getElementById('m_boxCombinado').style.display = (f==='Combinado') ? 'block':'none';
  document.getElementById('m_boxValorUnico').style.display = (f==='Combinado') ? 'none':'block';
}

function fecharModal(){
  document.getElementById('modalBackdrop').style.display='none';
  editIndex = -1;
}
window.fecharModal = fecharModal;
// ========================= PARTE 10/18 =========================
async function salvarEdicaoEntrada(){
  if(editIndex<0) return;
  const e = entradas[editIndex];
  const id = entradas[editIndex].id;

  const formaSel = document.getElementById('m_formaPagamento').value;
  let pagamento = {pix:0, cartao:0, dinheiro:0};
  let total = 0;

  if (formaSel==='Combinado'){
    pagamento = {
      pix: parseNum(document.getElementById('m_payPixVal').value),
      dinheiro: parseNum(document.getElementById('m_payDinVal').value),
      cartao: parseNum(document.getElementById('m_payCartaoVal').value),
    };
    total = somaPag(pagamento);
    if (total<=0){ alert('Informe pelo menos um valor no combinado.'); return; }
  } else {
    total = parseNum(document.getElementById('m_valor').value);
    if (total<=0){ alert('Informe um valor v√°lido.'); return; }
    if (formaSel==='Pix') pagamento.pix = total;
    if (formaSel==='Dinheiro') pagamento.dinheiro = total;
    if (formaSel==='Cart√£o') pagamento.cartao = total;
  }

  const novo = {
    ...e,
    data: document.getElementById('m_data').value || today,
    cliente: (document.getElementById('m_cliente').value||'').trim().toUpperCase(),
    tipo: document.getElementById('m_tipo').value,
    instalacao: document.getElementById('m_instalacao').value,
    qtd: parseInt(document.getElementById('m_qtd').value||'1',10),
    valor: total,
    pagamento,
    forma: (formaSel==='Combinado') ? fmtPag(pagamento) : formaSel,
  };

  const t = novo.tipo;
  if (t.includes('Servi√ßo') || t === 'Servi√ßo' || t === 'Dianteiro + Traseiro + Servi√ßo'){
    novo.descricao = (document.getElementById('m_descServico').value||'').trim().toUpperCase();
  } else {
    novo.descricao = '';
  }

  await updateDoc(doc(db, 'entradas', id), novo);
  fecharModal();
}
window.salvarEdicaoEntrada = salvarEdicaoEntrada;

async function excluirEntrada(realIndex){
  const e = entradas[realIndex];
  if(!e) return;

  if(!canDeleteEntrada(e)){
    return alert('Sem permiss√£o: funcion√°rio s√≥ pode excluir lan√ßamentos do dia.');
  }
  if(!confirm('Excluir esta entrada?')) return;

  await deleteDoc(doc(db, 'entradas', e.id));
}
window.excluirEntrada = excluirEntrada;
// ========================= PARTE 11/18 =========================
// ====== Render principal ======
function render(){
  const busca = (document.getElementById('campoBusca')?.value || '').toLowerCase();
  const diaFiltro = document.getElementById('filtroDia')?.value || '';
  const mesFiltro = document.getElementById('filtroMes')?.value || '';

  const filtroAtivo = (data) => {
    if(role!=='admin') return data===today;
    if(diaFiltro) return data===diaFiltro;
    if(mesFiltro) return data?.startsWith(mesFiltro);
    return true;
  };

  const ent = entradas.map((e,idx)=>({e,idx}))
    .filter(o=>filtroAtivo(o.e.data))
    .filter(o=>{
      if(role!=='admin') return true;
      const txt=(o.e.cliente+o.e.tipo+o.e.forma).toLowerCase();
      return !busca || txt.includes(busca);
    });

  const te = document.querySelector('#tabelaEntradas tbody');
  te.innerHTML = ent.map(o=>{
    const e = o.e;
    const extrasTxt = (Array.isArray(e.extras) && e.extras.length>0)
      ? e.extras.map(x=>`${x.qtd}√ó ${x.tipo}${x.obs?` (${x.obs})`:''}`).join(', ')
      : '-';

    const podeExcluir = canDeleteEntrada(e);

    return `
      <tr>
        <td>${esc(e.data||'')}</td>
        <td>${esc(e.cliente||'')}</td>
        <td>${extrasTxt}</td>
        <td>${esc(e.instalacao||'-')}</td>
        <td>${esc(e.forma||'-')}</td>
        <td>${BRL(e.valor||0)}</td>
        <td class="nowrap">
          <button class="secondary" onclick="abrirModalEntrada(${o.idx})">‚úèÔ∏è</button>
          ${(role==='admin' || podeExcluir) ? `<button class="danger" onclick="excluirEntrada(${o.idx})">üóëÔ∏è</button>` : ''}
        </td>
      </tr>`;
  }).join('');

  const sai = saidas.map((s,idx)=>({s,idx}))
    .filter(o=>filtroAtivo(o.s.data))
    .filter(o=>{
      if(role!=='admin') return true;
      const txt=(o.s.descricao+o.s.categoria).toLowerCase();
      return !busca || txt.includes(busca);
    });

  const ts = document.querySelector('#tabelaSaidas tbody');
  ts.innerHTML = sai.map(o=>{
    const s=o.s;
    return `
      <tr>
        <td>${esc(s.data||'')}</td>
        <td>${esc(s.descricao||'')}</td>
        <td>${esc(s.categoria||'')}</td>
        <td>${BRL(s.valor||0)}</td>
        <td class="nowrap">
          <button class="secondary" onclick="abrirModalSaida(${o.idx})">‚úèÔ∏è</button>
          ${(role==='admin') ? `<button class="danger" onclick="excluirSaida(${o.idx})">üóëÔ∏è</button>` : ''}
        </td>
      </tr>`;
  }).join('');
// ========================= PARTE 12/18 =========================
  const totEnt = ent.reduce((a,b)=>a+(b.e.valor||0),0);
  const totSai = sai.reduce((a,b)=>a+(b.s.valor||0),0);

  let totPix=0, totDin=0, totCart=0;
  for(const o of ent){
    const p = o.e.pagamento||{};
    totPix+=parseNum(p.pix); totDin+=parseNum(p.dinheiro); totCart+=parseNum(p.cartao);
  }

  const totalFolha = (role==='admin')
    ? funcionarios.filter(f=>!!f.ativo).reduce((a,b)=>a+parseNum(b.salario),0)
    : 0;

  const saldo  = totEnt - totSai - totalFolha;

  document.getElementById('totalEntradas').textContent = BRL(totEnt);
  document.getElementById('totalSaidas').textContent = BRL(totSai);
  document.getElementById('totalFolha').textContent  = BRL(totalFolha);
  document.getElementById('saldo').textContent       = BRL(saldo);
  document.getElementById('totalPix').textContent    = BRL(totPix);
  document.getElementById('totalCartao').textContent = BRL(totCart);
  document.getElementById('totalDinheiro').textContent = BRL(totDin);

  atualizarCountEntradas();
}
window.render = render;

// Lancamentos
function atualizarCountEntradas(){
  const badge = document.getElementById("countEntradas");
  if(!badge) return;
  const total = document.querySelectorAll("#tabelaEntradas tbody tr").length;
  badge.innerText = total + " lan√ß.";
}
// ========================= PARTE 13/18 =========================
// ====== CRUD SA√çDAS ======
async function adicionarSaida(){
  const data  = document.getElementById('dataSaida').value || today;
  const desc  = (document.getElementById('descricaoSaida').value||'').trim().toUpperCase();
  const cat   = document.getElementById('categoriaSaida').value;
  const valor = parseNum(document.getElementById('valorSaida').value);

  if(!desc){ alert('Informe a descri√ß√£o.'); return; }
  if(valor<=0){ alert('Informe um valor v√°lido.'); return; }

  const nova = { data, descricao: desc, categoria: cat, valor, createdAt: serverTimestamp() };
  await addDoc(collection(db,'saidas'), nova);

  document.getElementById('descricaoSaida').value='';
  document.getElementById('valorSaida').value='';
}
window.adicionarSaida = adicionarSaida;

function abrirModalSaida(idx){
  const s = saidas[idx];
  if(!s) return;
  saidaEditIndex = idx;

  document.getElementById('m_dataSaida').value  = s.data || today;
  document.getElementById('m_descSaida').value  = s.descricao || '';
  document.getElementById('m_categoriaSaida').value = s.categoria || 'Outros';
  document.getElementById('m_valorSaida').value = s.valor || 0;

  document.getElementById('modalSaidaBackdrop').style.display='flex';
}
window.abrirModalSaida = abrirModalSaida;

function fecharModalSaida(){
  document.getElementById('modalSaidaBackdrop').style.display='none';
  saidaEditIndex=-1;
}
window.fecharModalSaida = fecharModalSaida;

async function salvarEdicaoSaida(){
  if(saidaEditIndex<0) return;
  const id = saidas[saidaEditIndex].id;

  const novo = {
    data: document.getElementById('m_dataSaida').value || today,
    descricao: (document.getElementById('m_descSaida').value||'').trim().toUpperCase(),
    categoria: document.getElementById('m_categoriaSaida').value,
    valor: parseNum(document.getElementById('m_valorSaida').value)
  };

  await updateDoc(doc(db,'saidas',id),novo);
  fecharModalSaida();
}
window.salvarEdicaoSaida = salvarEdicaoSaida;

async function excluirSaida(idx){
  const s = saidas[idx];
  if(!s) return;

  if(role!=='admin'){
    alert('Somente o administrador pode excluir sa√≠das.');
    return;
  }
  if(!confirm('Excluir esta sa√≠da?')) return;
  await deleteDoc(doc(db,'saidas',s.id));
}
window.excluirSaida = excluirSaida;
// ========================= PARTE 14/18 =========================
// ====== FUNCION√ÅRIOS (ADMIN) ======
function renderFuncionarios(){
  if(role!=='admin') return;
  const tb = document.querySelector('#tabelaFuncionarios tbody');
  tb.innerHTML = funcionarios.map((f,i)=>`
    <tr>
      <td>${esc(f.nome||'')}</td>
      <td>${BRL(f.salario||0)}</td>
      <td>${f.ativo ? 'Ativo' : 'Inativo'}</td>
      <td class="nowrap">
        <button class="secondary" type="button" onclick="abrirModalFunc(${i})">‚úèÔ∏è</button>
        <button class="danger" type="button" onclick="excluirFunc('${f.id}')">üóëÔ∏è</button>
      </td>
    </tr>
  `).join('');
}

async function adicionarFuncionario(){
  if(role!=='admin') return alert('Apenas admin.');
  const nome = (document.getElementById('funcNome').value||'').trim().toUpperCase();
  const salario = parseNum(document.getElementById('funcSalario').value);
  const ativo = document.getElementById('funcAtivo').value === 'true';

  if(!nome) return alert('Informe o nome.');
  if(salario<=0) return alert('Informe um sal√°rio v√°lido.');

  await addDoc(collection(db,'funcionarios'), { nome, salario, ativo, createdAt: serverTimestamp() });

  document.getElementById('funcNome').value='';
  document.getElementById('funcSalario').value='';
  document.getElementById('funcAtivo').value='true';
}

function abrirModalFunc(i){
  funcEditIndex=i;
  const f=funcionarios[i];
  document.getElementById('mFuncNome').value = f.nome||'';
  document.getElementById('mFuncSalario').value = parseNum(f.salario)||0;
  document.getElementById('mFuncAtivo').value = String(!!f.ativo);
  document.getElementById('modalFuncBackdrop').style.display='flex';
}
window.abrirModalFunc = abrirModalFunc;

function fecharModalFunc(){
  document.getElementById('modalFuncBackdrop').style.display='none';
  funcEditIndex=-1;
}
window.fecharModalFunc = fecharModalFunc;

async function salvarFunc(){
  if(role!=='admin') return;
  if(funcEditIndex<0) return;
  const f=funcionarios[funcEditIndex];

  const nome = (document.getElementById('mFuncNome').value||'').trim().toUpperCase();
  const salario = parseNum(document.getElementById('mFuncSalario').value);
  const ativo = document.getElementById('mFuncAtivo').value==='true';

  if(!nome) return alert('Informe o nome.');
  if(salario<=0) return alert('Informe um sal√°rio v√°lido.');

  await updateDoc(doc(db,'funcionarios',f.id), { nome, salario, ativo });
  fecharModalFunc();
}
window.salvarFunc = salvarFunc;

async function excluirFunc(id){
  if(role!=='admin') return;
  if(!confirm('Excluir funcion√°rio?')) return;
  await deleteDoc(doc(db,'funcionarios',id));
}
window.excluirFunc = excluirFunc;
// ========================= PARTE 15/18 =========================
async function recalcularFolha(){
  if(role!=='admin') return alert('Apenas admin.');
  const mes = new Date().toISOString().slice(0,7);

  const funcsAtivos = funcionarios.filter(f=>!!f.ativo);
  const totalFolha = funcsAtivos.reduce((a,b)=>a+parseNum(b.salario),0);

  const totalMes = entradas
    .filter(e=>String(e.data||'').startsWith(mes))
    .reduce((a,b)=>a+parseNum(b.valor),0);

  alert(
    `Folha ${mes}\n\n` +
    (funcsAtivos.length ? funcsAtivos.map(f=>`${f.nome}: ${BRL(f.salario)}`).join('\n') : '(sem ativos)') +
    `\n\nTOTAL FOLHA: ${BRL(totalFolha)}\nFATURAMENTO: ${BRL(totalMes)}`
  );

  render();
}
window.recalcularFolha = recalcularFolha;

// ====== ESTOQUE (ADMIN) ======
function renderEstoque(){
  if(role!=='admin') return;
  const tb = document.querySelector('#tabelaEstoque tbody');
  tb.innerHTML = estoque.map((p,i)=>{
    const low = parseInt(p.qtd||0,10) < parseInt(p.minimo||0,10);
    return `
      <tr style="${low ? 'color:#f87171' : ''}">
        <td>${esc(p.nome||'')}</td>
        <td>${parseInt(p.qtd||0,10)}</td>
        <td>${parseInt(p.minimo||0,10)}</td>
        <td class="nowrap">
          <button class="secondary" type="button" onclick="abrirModalEst(${i})">‚úèÔ∏è</button>
          <button class="danger" type="button" onclick="excluirEst('${p.id}')">üóëÔ∏è</button>
        </td>
      </tr>
    `;
  }).join('');
}

function renderEstoqueHist(){
  if(role!=='admin') return;
  const tb = document.querySelector('#tabelaEstoqueHist tbody');
  tb.innerHTML = estoqueHist.map(h=>{
    const dt = h.createdAt?.toDate ? h.createdAt.toDate() : null;
    const when = dt ? dt.toLocaleString('pt-BR') : '-';
    const diff = parseInt(h.depois||0,10) - parseInt(h.antes||0,10);
    const sinal = diff>0 ? `+${diff}` : `${diff}`;
    return `
      <tr>
        <td>${esc(when)}</td>
        <td>${esc(h.produto||'')}</td>
        <td>${parseInt(h.antes||0,10)}</td>
        <td>${parseInt(h.depois||0,10)}</td>
        <td>${esc(sinal)}</td>
      </tr>
    `;
  }).join('');
}

async function adicionarProduto(){
  if(role!=='admin') return alert('Apenas admin.');
  const nome = (document.getElementById('estNome').value||'').trim().toUpperCase();
  const qtd = parseInt(document.getElementById('estQtd').value||'0',10);
  const minimo = parseInt(document.getElementById('estMin').value||'0',10);

  if(!nome) return alert('Informe o produto.');
  if(qtd<0 || minimo<0) return alert('Qtd/m√≠nimo inv√°lidos.');

  await addDoc(collection(db,'estoque'), { nome, qtd, minimo, createdAt: serverTimestamp() });

  document.getElementById('estNome').value='';
  document.getElementById('estQtd').value='';
  document.getElementById('estMin').value='';
}
// ========================= PARTE 16/18 =========================
function abrirModalEst(i){
  estEditIndex=i;
  const p=estoque[i];
  document.getElementById('mEstNome').value = p.nome||'';
  document.getElementById('mEstQtd').value  = parseInt(p.qtd||0,10);
  document.getElementById('mEstMin').value  = parseInt(p.minimo||0,10);
  document.getElementById('modalEstBackdrop').style.display='flex';
}
window.abrirModalEst = abrirModalEst;

function fecharModalEst(){
  document.getElementById('modalEstBackdrop').style.display='none';
  estEditIndex=-1;
}
window.fecharModalEst = fecharModalEst;

async function salvarEst(){
  if(role!=='admin') return;
  if(estEditIndex<0) return;
  const p=estoque[estEditIndex];

  const nome = (document.getElementById('mEstNome').value||'').trim().toUpperCase();
  const depois = parseInt(document.getElementById('mEstQtd').value||'0',10);
  const minimo = parseInt(document.getElementById('mEstMin').value||'0',10);
  const antes = parseInt(p.qtd||0,10);

  if(!nome) return alert('Informe o produto.');
  if(depois<0 || minimo<0) return alert('Qtd/m√≠nimo inv√°lidos.');

  await updateDoc(doc(db,'estoque',p.id), { nome, qtd: depois, minimo });

  if(depois !== antes){
    await addDoc(collection(db,'estoque_historico'), {
      produto: nome,
      antes,
      depois,
      createdAt: serverTimestamp()
    });
  }

  fecharModalEst();
}
window.salvarEst = salvarEst;

async function excluirEst(id){
  if(role!=='admin') return;
  if(!confirm('Excluir produto?')) return;
  await deleteDoc(doc(db,'estoque',id));
}
window.excluirEst = excluirEst;
// ========================= PARTE 17/18 =========================
// ====== FILTROS & RELAT√ìRIOS ======
function imprimirRelatorio(){
  const area = document.getElementById('printArea');
  const dataHora = new Date().toLocaleString('pt-BR');

  let html = `
    <div style="font-family:Arial">
      <div style="text-align:center;margin-bottom:18px">
        <h2 style="margin:0;font-size:20px;">Relat√≥rio Financeiro ‚Äî Real Car</h2>
        <div style="font-size:12px;color:#555;margin-top:4px;">
          Gerado em ${dataHora}
        </div>
      </div>

      <table border="1" cellspacing="0" cellpadding="6"
        style="width:100%;font-size:12px;border-collapse:collapse">
        <tr>
          <th>Data</th>
          <th>Tipo</th>
          <th>Descri√ß√£o</th>
          <th>Categoria / Instala√ß√£o</th>
          <th>Forma</th>
          <th>Valor</th>
        </tr>
  `;

  entradas.forEach(e=>{
    html += `
      <tr>
        <td>${esc(e.data)}</td>
        <td>Entrada</td>
        <td>${esc(e.cliente)}</td>
        <td>${esc(e.instalacao||"-")}</td>
        <td>${esc(e.forma||"-")}</td>
        <td>${BRL(e.valor||0)}</td>
      </tr>
    `;
  });

  saidas.forEach(s=>{
    html += `
      <tr>
        <td>${esc(s.data)}</td>
        <td>Sa√≠da</td>
        <td>${esc(s.descricao)}</td>
        <td>${esc(s.categoria||"-")}</td>
        <td>-</td>
        <td>${BRL(s.valor||0)}</td>
      </tr>
    `;
  });

  html += `</table></div>`;
  area.innerHTML = html;

  const w = window.open('', 'PRINT', 'height=800,width=1000');
  w.document.write(`<html><head><title>Impress√£o</title></head><body>${area.innerHTML}</body></html>`);
  w.document.close();
  w.focus();
  w.print();
  w.close();
}
window.imprimirRelatorio = imprimirRelatorio;

// stubs (se voc√™ n√£o tiver essas fun√ß√µes ainda, n√£o quebra)
function limparFiltros(){ 
  const b = document.getElementById('campoBusca'); if(b) b.value='';
  const d = document.getElementById('filtroDia');  if(d) d.value = (role==='admin' ? '' : today);
  const m = document.getElementById('filtroMes');  if(m) m.value='';
  render();
}
function exportarCSV(){ alert('Exportar CSV: implemente aqui (se j√° tiver, mantenha o seu).'); }
function exportarJSON(){ alert('Exportar Backup: implemente aqui (se j√° tiver, mantenha o seu).'); }
function fecharMes(){ alert('Fechar m√™s: implemente aqui (se j√° tiver, mantenha o seu).'); }
// ========================= PARTE 18/18 =========================
// ====== Seguran√ßa final ======
window.addEventListener('beforeunload', ()=>{
  safeUnsubAll();
});

// start: app hidden
document.getElementById('appShell').style.display='none';
</script>

</body>
</html>
